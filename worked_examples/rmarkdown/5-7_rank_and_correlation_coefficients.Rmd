---
title: "Rank and correlation coefficients"
author: "Worked example 5.7"
---

```{r, setup, include=FALSE}
ggplot2::theme_set(ggplot2::theme_bw(base_size = 10))
knitr::opts_chunk$set(message = FALSE, warning = FALSE)
```

# Loading the Data

```{r, message=FALSE, warning=FALSE}
library(tidyverse)
library(hydroDrought) 

regional
```


```{r, message=FALSE, warning=FALSE}
# functions for the percentiles we want to include
my_percentiles <- function(x)
{
  as_tibble(as.list(lfquantile(x, exc.freq = c(0.95, 0.9, 0.7, 0.5))))
}

# functions for the mean annual minima 
my_mams <- function(discharge, time, n = c(1, 10, 30))
{
  names(n) <- paste0("MAM(", n, ")")
  
  long <- map_df(n, ~map(list(value = mean_annual_minimum), exec, 
                         n = .x,
                         discharge = discharge, time = time,  
                         origin = "-09-01", na.rm = TRUE), 
                 .id = "variable")
  
  pivot_wider(long, names_from = variable, values_from = value)
}


indices <- regional  %>%
  select(station, data = discharge, area = catchment) %>%
  filter(is.finite(area)) %>%
  mutate(
    # data = map2(data, area, ~mutate(.x, discharge = discharge * 1000 / .y)),
    Q.mean = map_dbl(data, ~mean(.$discharge, na.rm = TRUE)),
    quantiles = map(data, ~my_percentiles(.x$discharge)),
    mams = map(data, ~my_mams(discharge = .x$discharge, time = .x$time))
  )  %>%
  select(-data, -area) %>%
  unnest(cols = c(quantiles, mams)) %>%
  print()
```


```{r}
# derived indices
indices <- indices %>%
  mutate(
    `Q90/Q50` = Q90/Q50,
    `Q95/Q50` = Q95/Q50,
    `MAM(30)/Q50` = `MAM(30)`/Q50,
    `MAM(10)/Q50` = `MAM(10)`/Q50,
    `MAM(1)/Q50` = `MAM(1)`/Q50,
  )
```



```{r, warning=FALSE, message=FALSE}
# install_github("vqv/ggbiplot")
df <- indices %>%
  column_to_rownames(var = "station") 

pca <- prcomp(df, center = TRUE, scale. = TRUE)

ggbiplot::ggbiplot(pca, labels=rownames(df))
```

