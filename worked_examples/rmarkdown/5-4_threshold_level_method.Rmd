---
title: "Worked example 5.4: Threshold level method"
---

```{r, setup, include=FALSE}
ggplot2::theme_set(ggplot2::theme_bw(base_size = 10))
knitr::opts_chunk$set(message = FALSE, warning = FALSE)
fmt_date <- function(x) trimws(format(x, format = "%e %B %Y"))
```

```{r, loadingData, echo=FALSE}
library(tidyverse)
library(hydroDrought)

ngaruroro <- international %>%
  filter(river == "Ngaruroro") %>%
  select(data) %>%
  unnest(data) 
```



It is possible to analyze any time series of river flow as long as there are not too many missing values in the dataset and a meaningful $Q_0$  threshold is chosen. Data from River Ngaruroro at Kuripapango (NZ) are used to demonstrate the procedure in the example below.

# Loading the Data
`r round(as.double(diff(range(ngaruroro$time)), "days") / 365.25, 1)`  years of 
daily flow (`r fmt_date(min(ngaruroro$time))` to `r fmt_date(max(ngaruroro$time))`)
are analysed. In this river the low flow period covers the turn of the calendar 
year. To avoid problems with allocating droughts to a specific calendar year 
because of drought events starting in one year and ending in another year, the 
start of the year is defined to be 1 September. An event is attributed to the 
year it starts. 

```{r, loadingData, eval=TRUE, echo=TRUE}
```

# Preprocessing
The time series, Ngaruroro, contains missing values.  We do not know if a missing 
value (`NA`) is 'a flow below the threshold' or 
'above the threshold' as the flow value itself is unknown. A single missing value 
will cause the function `drought_events()` to terminate a dry spell (drought event) 
or wet spell. Subsequently most characteristics derived for this event (e.g. drought 
duration, drought termination, drought volume, ... ) will not be correct. 

```{r, preprocessing, echo=FALSE}
ngaruroro <- ngaruroro %>%
  sanitize_ts(approx.missing = 14) %>%
  mutate(
    year = water_year(time, origin = "-09-01")
  )

coverage <- ngaruroro %>%
  filter(!is.na(discharge)) %>%
  pull(time) %>%
  coverage_yearly(origin = "-09-01")

incomplete <- coverage %>%
  filter(days.missing > 0) 

complete <- coverage %>%
  filter(days.missing == 0)

ngaruroro <- ngaruroro %>%
  anti_join(incomplete, by = "year")
```

```{r, properties-dataset, echo=FALSE}
nyear <- length(unique(ngaruroro$year))
nremoved <- hydroDrought:::numbers_english(nrow(incomplete))
years.removed <- hydroDrought:::paste_with_and(paste(
  incomplete$year, 
  substr(incomplete$year + 1, 3L, 4L), sep = "/")
)
```


A conservative approach would be to eliminate years with missing values completely.
Instead, to avoid loosing too many years of observation, periods of missing data 
can be interpolated if they are of short duration. Here periods of missing data 
have been interpolated if of short duration (< 15 days), whereas years containing
long periods of missing values (â‰¥ 15 days) have been removed. After preprocessing 
the time series, `r nyear` years of daily flow (`r fmt_date(min(ngaruroro$time))` 
to `r fmt_date(max(ngaruroro$time))`) will be analysed. In total 
`r nremoved` years are omitted from the series (`r years.removed`). 


```{r, preprocessing, echo=TRUE, eval=FALSE}
```


The table below displays the year removed, the total number of days in the year
(365 or 366 for leap years), the number of days with flow observations, 
the number of `NA`-values (days with missing data) and the remaining fraction of days.

```{r}
print(incomplete)
```


#	Threshold selection and drought events
A sequence of drought events is obtained from the streamflow hydrograph by 
considering periods with flow below a certain threshold, $Q_0$. In this 
example $Q_{90} = `r round(lfquantile(ngaruroro$discharge, exc.freq = 0.9), 2)`$m<sup>3</sup>s<sup>-1</sup> is used as threshold. A table of drought characteristics 
is derived with the function `drought_events()`. 

```{r}
q90 <- lfquantile(ngaruroro$discharge, exc.freq = 0.9) %>%
  print()

droughts <- ngaruroro %>%
  drought_events(threshold = q90, pooling = "none") 
```


`r tufte::margin_note("Table 5.8 Drought deficit characteristics, River Ngaruroro at Kuripapango, NZ.")`
```{r, echo=FALSE}
droughts %>%
  hydroDrought:::export_table(name = "Tab5.8") %>%
  print()
```

The table displayed above includes:

* `first.day`: the start date, defined as the first day below the threshold;
* `last.day`: the end date, defined as the last day below the threshold; 
* `duration`: the drought duration (days), defined as `last.day - first.day + 1`
* `volume`: the deficit volume in m<sup>3</sup>, defined as the sum of the daily
deficit flows times the duration in days;
* `qmin`: the minimum flow in m<sup>3</sup>s<sup>-1</sup>, defined as the minimum flow $Q_{min}$ within a drought event;
* `tqmin`: the date of the minimum flow.


# 	Removing minor droughts (Filtering)
Several minor droughts, lasting for a few days only, can be observed. To reduce the problem of minor droughts two restrictions are imposed:

* a minimum drought duration, $d_{min}$ that removes droughts with duration less 
than the specified number of days;

* a minimum drought deficit volume (coefficient $\alpha$), that removes droughts 
with a deficit volume less than a certain fraction $\alpha$ of the maximum 
drought deficit volume in the complete series of drought events. 

```{r, echo=FALSE}
vmin <- max(droughts$volume) * 0.005
```

```{r, minorDroughts, echo = FALSE}
droughts <- droughts %>%
  mutate(is.minor = duration < 5 | volume < max(volume) * 0.005) 
```

We will append a logical column called `is.minor` to the table of drought events.
It is `TRUE` when drought duration is less than five days or if the drought 
volume is less than 
`r format(vmin, big.mark = "<i>&nbsp;</i>")`<i>&nbsp;</i>m<sup>3</sup> 
(0.5% of the maximum drought deficit volume). Due to this criteria a total number 
of `r sum(droughts$is.minor)` droughts are considered minor droughts.


```{r, minorDroughts, echo = TRUE, eval=FALSE}
```
```{r}
print(droughts)
```




#	Eliminating dependent droughts (Pooling)
The inter-event time criterion (IC) is used to pool dependent droughts which 
are separated by a short period of flow above the threshold. If the time between 
two droughts is less than a critical duration, $t_{min}$, the two events are pooled. 

In this example $t_{min}$ is set equal to two days. 

```{r}
pooled <- ngaruroro %>%
  drought_events(
    threshold = q90, pooling = "inter-event", 
    pooling.pars = list(min.duration = 2, min.vol.ratio = Inf)
  ) %>%
  filter(duration >= 5, volume > max(volume) * 0.005) %>%
  arrange(desc(duration)) %>%
  print()
```

When drought events were pooled the table of drought events contain two 
more columns:

* `dbt`: the duration below the threshold, i.e. the drought duration minus short 
period(s) above the threshold; 

* `pooled`: the number of drought events. 

The drought deficit characteristics of the ten longest (pooled) drought events are given in the table above. In total there are `r nrow(pooled)` drought 
events, on average `r round(nrow(pooled) / nyear, 2)` events per year. 

To summarize all drought events for every year one could calculate
the `year` based on the year of the `first.day` of and event and derive for
example the following metrics, the number of droughts in a year, the total drought duration in a year and minimum flow in a year:

```{r}
pooled %>%
  mutate(
    year = water_year(first.day, origin = "-09-01")
  ) %>%
  group_by(year) %>%
  summarise(
    n.droughts = n(),
    real.duration = sum(dbt), 
    min.flow = min(qmin)
  )
```


```{r, echo=FALSE}
p <- pooled %>%
  mutate(
    year = water_year(first.day, origin = "-09-01")
  ) %>%
  group_by(year) %>%
  mutate(
    event = group_const_value(event) + 1
  ) %>%
  ungroup() %>%
  select(event, duration, year) %>%
  right_join(complete %>% select(year), by = "year") 

major <- hydroDrought:::paste_with_and(sort(head(p$year)))
```


The time series of the drought duration can be seen in Figure 5.12, and the major 
droughts are found in `r major`.

```{r, echo=FALSE, }
fig.cap <- "Figure 5.12 Time series of drought duration for River Ngaruroro at Kuripapango (NZ). Selection criteria: threshold level = $Q_{90}$, $d_{min} = 5$ days, $\\alpha = 0.005$ and $t_{min} = 2$ days."
```
```{r,fig.cap=fig.cap, echo = FALSE}
ggplot(p, aes(x = event, y = as.double(duration))) + 
  geom_col(position = "stack", col = "white") + 
  labs(x = "Number of drought events", y = "Drought duration (days)") +
  facet_wrap(vars(year), ncol = 10) + 
  theme(panel.grid.major.x = element_blank(),
        panel.grid.minor.x = element_blank())
```


A histogram of the drought duration is seen in Figure 5.13, and a very skewed distribution is revealed. Minor droughts are dominating with `r sum(pooled$duration <= 10)` events lasting 
less than 11 days. Only `r sum(pooled$duration > 30)` events lasted more than 30 days. 

```{r, echo=FALSE, }
fig.cap <- "Figure 5.13 Histogram of drought duration for River Ngaruroro at Kuripapango (NZ). Selection criteria: threshold level = $Q_{90}$, $d_{min} = 5$ days, $\\alpha = 0.005$ and $t_{min} = 2$ days."
```
```{r, echo=TRUE, fig.cap=fig.cap}
ggplot(pooled, aes(duration)) + 
  geom_histogram(binwidth = 5, boundary = 0, closed = "left", 
                 size = 0.2, col = "black", fill = "grey90") + 
  scale_x_continuous(limits = c(0, NA)) + 
  scale_y_continuous(breaks = breaks_integer()) + 
  labs(x = "Drought duration (days)", y = "Counts")
```








