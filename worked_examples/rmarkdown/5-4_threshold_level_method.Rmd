---
title: "Threshold level method"
author: "Worked example 5.4"
---

```{r, setup, include=FALSE}
ggplot2::theme_set(ggplot2::theme_bw(base_size = 10))
knitr::opts_chunk$set(message = FALSE, warning = FALSE)
```

```{r, echo=FALSE, eval=FALSE}
# filter(year >= 1964, year <= 1999) # original filter
```

The threshold level method can be used to derive drought events from a given 
time series of river flows. A drought event starts when the flow falls below a 
given threshold $Q_0$ and when the flow rises above the threshold the drought
event ends. 

# Loading the Data
It is possible to analyse any of the series in 
the International Data Set (Section 4.5.1) as long as there are not too many
missing values in the dataset and a meaningful threshold $Q_0$ is choosen. 
Data from River Ngaruroro at Kuripapango (NZ) are used to demonstrate the 
procedure in the example below. 

```{r}
library(tidyverse)
library(hydroDrought)

ngaruroro <- intl %>%
  filter(river == "Ngaruroro") %>%
  select(data) %>%
  unnest(data) 
```


Missing/unknown values (`NA`s) can neither be seen as 'a flow below the threshold' or 
'above the threshold' as the flow value itself is unknown. A single missing value 
will cause the function `drought_events()` to terminate a dry spell (drought event) 
or wet spell. Subsequently most characteristics derived for this event (e.g. drought 
duration, drought termination, drought volume, ... ) will be biased. 

A conservative approach would be to eliminate years with missing values completely. 
Instead periods of missing data can been interpolated if of short duration 
(e.g. < 15 days), removing only years with long periods of missing values. 

```{r}
ngaruroro <- ngaruroro %>%
  sanitize_ts(approx.missing = 14) %>%
  mutate(
    year = water_year(time, origin = "-09-01")
  ) %>%
  print()

incomplete <- ngaruroro %>%
  filter(!is.na(discharge)) %>%
  pull(time) %>%
  coverage_yearly(origin = "-09-01") %>%
  filter(days.missing > 0) %>%
  print()

ngaruroro <- ngaruroro %>%
  anti_join(incomplete, by = "year")
```



```{r, properties-dataset, echo=FALSE}
nyear <- length(unique(ngaruroro$year))
nremoved <- hydroDrought:::numbers_english(nrow(incomplete))
years.removed <- hydroDrought:::paste_with_and(paste(
  incomplete$year, 
  substr(incomplete$year + 1, 3L, 4L), sep = "/")
)
```

After preprocessing the time series `r nyear` years of daily flow
(`r min(ngaruroro$time)` to `r max(ngaruroro$time)`) will be analysed. 
In total `r nremoved` years are omitted from the series (`r years.removed`). 

In this river the low flow period covers the turn of the calendar year. 
To avoid problems with allocating droughts to a specific calendar year 
because of drought events starting in one year and ending in another year, 
the start of the year is defined to on September 1<sup>st</sup>. 

#	Threshold selection and drought events
A sequence of drought events is obtained from the streamflow hydrograph by 
considering periods with flow below a certain threshold, $Q_0$. In this 
example $Q_{90}$ is used as threshold. A table of drought characteristics 
is derived with the function `drought_events()`. 

```{r}
q90 <- lfquantile(ngaruroro$discharge, exc.freq = 0.9) %>%
  print()

droughts <- ngaruroro %>%
  drought_events(threshold = q90, pooling = "none") %>%
  print()
```

The table displayed above includes:

* the start date, defined as the `first.day` below the threshold;
* the end date, defined as the `last.day` below the threshold; 
* the drought `duration` (days), defined as the full drought duration 
(`last.day - first.day + 1`) 
* the deficit `volume` (in m<sup>3</sup>), defined as the sum of the daily
deficit flows times the duration in days;
* the minimum flow `qmin` (in m<sup>3</sup>s<sup>-1</sup>), defined as the minimum flow $Q_{min}$ within a drought event;
* and the date of the minimum flow `tqmin`.


# 	Removing minor droughts (Filtering)
To reduce the problem of minor droughts two restrictions can be imposed:

* a minimum drought duration, $d_{min}$ that removes droughts with duration less 
than the specified number of days;

* a minimum drought deficit volume (coefficient $\alpha$), that removes droughts 
with a deficit volume less than a certain fraction $\alpha$ of the maximum 
drought deficit volume in the complete series of drought events. 

```{r, echo=FALSE}
vmin <- max(droughts$volume) * 0.005
```


We will append a logical column called `is.minor` to the table of drought events.
It is `TRUE` when drought duration is less than five days and if the drought 
volume is less than 
`r format(vmin, big.mark = "<i>&nbsp;</i>")`<i>&nbsp;</i>m<sup>3</sup> 
(5% of the maximum drought deficit volume). 

```{r}
droughts <- droughts %>%
  mutate(is.minor = duration < 5 | volume < max(volume) * 0.005) %>%
  print()
```

Due to this criteria a total number of `r sum(droughts$is.minor)` droughts 
are considered minor droughts.

```{r, echo=FALSE, }
fig.cap <- paste(
  "Figure x.x: Drought duration and drought deficit volume for years 2010 to 2016.",
  "A drought event is classified as a minor drought if the duration or the volume is",
  "below a given threshold."
)
```
```{r, echo=FALSE, fig.cap=fig.cap}
thres <- droughts %>%
  summarise(duration = 5, volume = max(volume) * 0.005) %>%
  pivot_longer(cols = everything(), names_to = "variable")

d <- droughts %>%
  mutate(
    year = water_year(first.day, origin = "-09-01"),
    minor = if_else(duration < 5 | volume < min(volume) * 0.005, "minor drought", "drought"),
    # label = factor(event, event, labels = sprintf("%i (%i)", event, year)),
    duration = as.double(duration, units = "days"),
    # duration = if_else(duration == 1, 1.051, duration),
    event = factor(event)
  ) %>%
  filter(year >= 2010) %>%
  select(event, minor, duration, volume, year) %>%
  pivot_longer(cols = c(duration, volume), names_to = "variable")

library(cowplot)
p1 <- d %>%
  filter(variable == "duration") %>%
  ggplot(aes(event, value, fill = minor)) + 
  geom_col() + 
  geom_hline(data = filter(thres, variable == "duration"), 
             aes(yintercept = value), 
             linetype = "dashed", size = 0.2) + 
  labs(y = "Drought duration in days") + 
  # scale_y_log10() + 
  scale_fill_manual("", values = c(drought = "grey30", "minor drought" = "grey70")) + 
  facet_grid(rows = vars(variable), cols = vars(year), scales = "free", space = "free_x") + 
  theme(axis.title.x = element_blank(), #element_text(angle = 90, hjust = 1, vjust = 0.5), 
        legend.position = "top",
        panel.grid = element_blank(), 
        strip.text.y = element_blank())

p2 <- d %>%
  filter(variable == "volume") %>%
  ggplot(aes(event, value, fill = minor)) + 
  geom_col() + 
  geom_hline(data = filter(thres, variable == "volume"), 
             aes(yintercept = value), 
             linetype = "dashed", size = 0.2) + 
  labs(x = "Drought event number", y = "Drought deficit volume in mÂ³") + 
  scale_y_log10() + 
  scale_fill_manual("", values = c(drought = "grey30", "minor drought" = "grey70")) + 
  facet_grid(rows = vars(variable), cols = vars(year), scales = "free", space = "free_x") + 
  theme(axis.text.x = element_text(angle = 90, hjust = 1, vjust = 0.5), 
        legend.position = "none", 
        panel.grid = element_blank(), 
        strip.text.y = element_blank())

p <- plot_grid(p1, p2, align = "v", axis = "x", ncol = 1)
p
```


#	Eliminating dependent droughts (Pooling)
The inter-event time criterion (IC) is used to pool dependent droughts which 
are separated by a short period of flow above the threshold. If the time between 
two droughts is less than a critical duration, $t_{min}$, the two events are pooled. 

In this example $t_{min}$ is set equal to two days. 

```{r}
pooled <- ngaruroro %>%
  drought_events(
    threshold = q90, pooling = "inter-event", 
    pooling.pars = list(min.duration = 2, min.vol.ratio = Inf)
  ) %>%
  filter(duration >= 5, volume > max(volume) * 0.005) %>%
  arrange(desc(duration)) %>%
  print()
```

Whenever drought events were pooled the table of drought events contain two 
more columns:

* the duration below the threshold `dbt`: full drought duration minus short 
periods (the inter-event time) above the threshold; 

* the number of `pooled` drought events. 

The drought deficit characteristics of the ten longest lasting (pooled) drought 
events are given in the table above. 

To summarise all drought events for every year one could calculate
the `year` based on the year of the `first.day` of and event and derive for
example the following metrics: 

```{r}
pooled %>%
  mutate(
    year = water_year(first.day, origin = "-09-01")
  ) %>%
  group_by(year) %>%
  summarise(
    n.droughts = n(),
    real.duration = sum(dbt), 
    min.flow = min(qmin)
  )
```

From the first table it can be seen that there are `r nrow(pooled)` drought 
events in total, on average `r round(nrow(pooled) / nyear, 2)` events every year. 
Minor droughts are dominating with `r sum(pooled$duration <= 10)` events lasting 
less than 11 days. Only `r sum(pooled$duration > 30)` events lasted more than 30 days. 

```{r, echo=FALSE}
p <- pooled %>%
  mutate(
    year = water_year(first.day, origin = "-09-01")
  ) %>%
  group_by(year) %>%
  mutate(event = group_const_value(event) + 1) %>%
  select(event, duration, year) %>%
  right_join(tibble(year = full_seq(.$year, 1)), by = "year")

major <- hydroDrought:::paste_with_and(head(p$year))
```


The time series of the drought duration can be seen in Figure 5.12, and the major 
droughts are found in `r major`.

```{r, echo=FALSE, }
fig.cap <- "Figure 5.12 Time series of drought duration for River Ngaruroro at Kuripapango (NZ). Selection criteria: threshold level = $Q_{90}$, $d_{min} = 5$ days, $\\alpha = 0.005$ and $t_{min} = 2$ days."
```
```{r,fig.cap=fig.cap, echo = FALSE}
ggplot(p, aes(x = event, y = as.double(duration))) + 
  geom_col(position = "stack", col = "white") + 
  labs(x = "Number of drought events", y = "Drought duration (days)") +
  facet_wrap(vars(year), ncol = 10) + 
  theme(panel.grid.major.x = element_blank(),
        panel.grid.minor.x = element_blank())
```


A histogram of the drought duration is seen in 
Figure 5.13, and a very skewed distribution is revealed.

```{r, echo=FALSE, }
fig.cap <- "Figure 5.13 Histogram of drought duration for River Ngaruroro at Kuripapango (NZ). Selection criteria: threshold level = $Q_{90}$, $d_{min} = 5$ days, $\\alpha = 0.005$ and $t_{min} = 2$ days."
```
```{r, echo=TRUE, fig.cap=fig.cap}
ggplot(pooled, aes(duration)) + 
  geom_histogram(binwidth = 5, boundary = 0, closed = "left", col = "white") + 
  scale_x_continuous(limits = c(0, NA)) + 
  scale_y_continuous(breaks = integer_breaks()) + 
  labs(x = "Drought duration (days)", y = "Counts")
```





```{r, echo=FALSE, eval=FALSE}
library(kableExtra)
pooled %>%
  kable(caption = "Table 5.8 Drought deficit characteristics, River Ngaruroro at Kuripapango, NZ. ")
```




