---
title: "Quantifying the human influence on drought"
author: "Worked example 10.1"
---

```{r, setup, include=FALSE}
ggplot2::theme_set(ggplot2::theme_bw(base_size = 10))
knitr::opts_chunk$set(message = FALSE, warning = FALSE)
```

```{r, echo = FALSE}
library(tidyverse)
library(hydroDrought)
# Load the data
guadiana <- read_tsv("../../data/Guadiana_Delay_LogEff_including_Psim.txt") %>%
  dplyr::select(time = "date.yyyymmdd",  Qsim, Qobs)  
# append_group(by = "day")
```

A comparison of two time series from the Upper-Guadiana catchment, one with and one without human influence, is done to demonstrate the catchment-scale observation-based methods to quantify the human influence on hydrological drought (Section 10.4.1; Fig. 10.6). These time series can be calculated from a paired catchment analysis, an upstream-downstream comparison, observed-naturalised comparison, or pre-post disturbance analysis (Section 10.4.1). In this example, we use the observed-naturalised approach. 

# Loading the data

We begin by loading the two time series from the Upper-Guadiana dataset: the benchmark (natural) time series and the human-influenced time series.

```{r}
library(tidyverse)
library(lubridate)
library(hydroDrought)

### Filter to the period 1960-2000 
### Rename the columns
### Calculate the water year
guadiana_full <- guadiana %>%
	dplyr::select(time, benchmark = Qsim, influenced = Qobs) %>%
  	mutate(
    	year = water_year(time)
	) %>%
	filter(year >= 1960,  year <= 2000) 

print(guadiana_full)
range(guadiana_full$time)
```

The benchmark time series is simulated as described in Section 9.3.3. In this case, the observed time series from the Upper-Guadiana catchment is the human-influenced time series (Section 4.5.X).



```{r, echo=FALSE}
fig.cap <- "Figure 10.xxxx: Time series showing the benchmark and human-influenced time series. Discharge is plotted on a log scale to emphasize low flow behavior. The grey region shows the comparison period for human influence (1981-2000)."

plot_df <- guadiana_full %>%	
	mutate(jdate = yday(time)) %>% 
	#dplyr::select(-time) %>% 
	pivot_longer(cols = c("benchmark", "influenced"))	 %>%
	rename(facet = name) %>%
	mutate(line = facet) %>%
	mutate(line = factor(line, levels = c("thresh_basis", "benchmark", "influenced"), labels = c("Threshold\nBasis", "Benchmark", "Human\nInfluenced"))) %>%
	mutate(facet = factor(facet, levels = c("thresh_basis", "benchmark", "influenced"), labels = c("Threshold Basis", "Benchmark", "Influenced"))) %>%
	mutate(label = "Threshold")

```

```{r, echo=FALSE, fig.cap=fig.cap}
### Plot the 1960-2000 timee series
p <- ggplot(plot_df, aes(x=time)) %>%
	 + geom_rect(aes(xmin=as.Date("1980-01-01"), xmax= as.Date("2000-12-31"), ymin=0, ymax=Inf), fill = "grey90", alpha = 0.2) %>% 
	 + geom_line(aes( y=value, colour = line)) %>%
	 + geom_vline(xintercept = c(as.Date("1981-01-01"), as.Date("2000-12-31")), linetype = "dashed", size = 0.5, colour = "grey30") %>%
	+ scale_colour_manual(name = "", values = c("black", "#377eb8"), limits = c("Benchmark", "Human\nInfluenced")) %>%
	+ facet_grid(facet~.) %>%
	+  scale_y_log10(name = "Discharge (mm/day)") %>%
	+ annotation_logticks(sides = "lr") %>%
	+ theme(panel.grid.minor = element_blank())	 

### Display figure (stored in variable p)
p
```

# Threshold calculation

In this example we use a daily varying threshold, the Q80, calculated based on a smoothed 30-day moving average series over the period 1960-2000. The threshold is derived based on the benchmark time series.

```{r}
### First apply a 30-day moving average smoother
### Then compute the Q80 for each day of the year
threshold <- guadiana_full %>%
  mutate(discharge = moving_average(benchmark, n = 30, sides = "center")) %>%
  var_threshold(vary.by = "day", fun = lfquantile, exc.freq = 0.80) 

print(threshold)
```



```{r, echo=FALSE}
fig.cap <- "Figure 10.xxxx: Benchmark discharge for the period 1960-2000 showing seasonality, with each line representing a year. The smoothed Q80 threshold is shown in bold red."

### Add julian dates and a plot date
plot_df <- guadiana_full %>%
	mutate(jdate = yday(time)) %>%
	mutate(plot_date = as.Date(paste0("2000-01-01"))+jdate - 1)

plot_thresh <- threshold %>% 
	mutate(jdate = yday(day)) %>%
	mutate(plot_date = as.Date(paste0("2000-01-01"))+jdate - 1)
```

```{r, echo=FALSE, fig.cap=fig.cap}
### Plot the threshold against flows
p <- ggplot(plot_df, aes(x=plot_date)) + 
	geom_line(aes(group=year, y=benchmark), alpha = 0.2) + 
	geom_line(data = plot_thresh, aes(y=threshold), colour="red", size = 1) + 
	scale_x_date(name = , "Month", date_labels = "%b") +
	scale_y_continuous(name = "Discharge (mm/day)")

### Display figure (stored in variable p)
p
```

# Calculate the benchmark drought indices

Apply the benchmark threshold (Step 2) to identify drought events in the benchmark time series using the threshold level method (Section 5.4.1) for a dplyr::selected period. Note that this time period can differ from the reference period used to calculate the benchmark threshold. In this example, we use the period 1981-2000, which equals the period with the main human intervention in the Upper Guadiana catchment. 

```{r}
# initialize empty list for events
events <- list(benchmark = NULL, influenced = NULL)

# initialize empty list for final drought characteristics
drought.char <- list(benchmark = NULL, influenced = NULL) 

# function that computes the drought characteristics given a table of events
summarize_dc <- function(x) {
  c("mean.duration" = as.double(mean(x$duration)), 
    "mean.deficit" = mean(x$volume))
}
```
Consecutive drought events with an inter-event time less than or equal to 10 days are pooled into a single drought event. To remove minor droughts, only drought events with a duration of more than 10 days are kept. The resultant drought indices of the naturalised benchmark time series are: (a) mean duration 91 days, and (b) mean deficit volume 58,000 mm.

```{r}
### Calculate the drought events for the benchmark time series
### Filter to 1981-2000
### use the benchmark column as discharge
events$benchmark <- guadiana_full %>%
  filter(year >= 1981, year <= 2000) %>%
  rename(discharge = benchmark) %>%
  drought_events(
    threshold = threshold,
    pooling = "inter-event",
    pooling.pars = list(min.duration = 10, min.vol.ratio = Inf)
  )  %>%
  filter(duration > 10)

# calculate the drought characteristics for the benchmark time series
drought.char$benchmark <- summarize_dc(events$benchmark)

print(events$benchmark)
```

# Calculate the human-influenced drought indices

Apply the benchmark threshold (Step 2) to identify drought events in the human-influenced time series. Note that we are using the same period (1981-2000) as was used to derive drought indices for the benchmark time series. Furthermore, we are applying the same inter-event criterion and exclusion of minor drought events (Step 3). The resultant drought indices of the human-influenced time series are: (a) mean duration 304 days, and (b) mean deficit volume 310,000 mm

```{r, echo=FALSE}
fig.cap <- "Figure 10.xxxx: Benchmark (top) and human-influenced (bottom) flows during the comparison period 1981-2000. The smoothed Q80 threshold is shown in red. Discharge is plotted on a log scale to emphasize low flow behavior."

### Create a dataframe of the threshold for each day
thresh_plot <- guadiana_full %>%
	dplyr::select(time, year) %>%
	mutate(jdate = yday(time))

plot_thresh <- thresh_plot %>%
	mutate(line = "threshold", facet = "benchmark") %>%
	bind_rows(thresh_plot %>% mutate(line = "threshold", facet = "influenced")) %>%
	left_join(threshold %>% mutate(jdate = yday(day)) %>% dplyr::select(-day), by = "jdate") %>%
	mutate(source = line) %>%
	rename(discharge = threshold)
	
### Merge discharge with the threshold and create columns for plotting
plot_df <- guadiana_full %>%
	pivot_longer(cols = c("benchmark", "influenced"), names_to = "source", values_to  = "discharge") %>%
	mutate(jdate = yday(time), year = year (time)) %>%
	mutate(line = source) %>%
	mutate(facet = source) %>%
	bind_rows(plot_thresh) %>%
	mutate(line = factor(line, levels = c("benchmark", "influenced", "threshold"), labels = c("Benchmark", "Human\nInfluenced", "Threshold"))) %>%
	mutate(facet = factor(facet, levels = c("benchmark", "influenced", "threshold"), labels = c("Benchmark", "Human\nInfluenced", "Threshold"))) %>%
	mutate(plot_date = as.Date(paste0("2000-01-01"))+jdate - 1)
```

```{r, echo=FALSE, fig.cap=fig.cap}
### Plot flow with time relative to the threshold
p <- ggplot(plot_df, aes(x=time)) %>%
	+ geom_line(aes( y=discharge, colour = line)) %>%
	+ facet_grid(facet~.) %>%
	+ scale_colour_manual(name = "", values = c("black", "#377eb8", "red"), limits = c("Benchmark", "Human\nInfluenced", "Threshold")) %>%
	+ scale_x_date(name = "Date", date_labels = "%Y") %>%
	+  scale_y_log10(name = "Discharge (mm/day)") %>%
	+ annotation_logticks(sides = "lr") %>%
	+ theme(panel.grid.minor = element_blank())	%>%
	+ coord_cartesian(xlim=c(as.Date("1981-01-01"), as.Date("2001-01-01"))) %>%
	+ theme(legend.position="bottom")

### Display figure (stored in variable p)
p
```

```{r}
### Calculate the drought events for the benchmark time series
### Filter to 1981-2000
### use the influenced column as discharge
events$influenced <- guadiana_full %>%
  filter(year >= 1981 & year <= 2000) %>%
   rename(discharge = influenced) %>% 
  drought_events(threshold = threshold,
                 pooling = "inter-event",
                 pooling.pars = list(min.duration = 10, min.vol.ratio = Inf))  %>%
  filter(duration > 10)

# calculate the drought characteristics for the human influenced time series
drought.char$influenced <- summarize_dc(events$influenced)
```


# Comparison of drought characteristics    
In this final step, we compare the drought indices between the benchmark and human-influenced time series. We calculate the percentage difference between the two sets of drought indices, $\Delta DC$ :

$$\Delta DC = \frac{DC_{HI} - DC_{BM}}{DC_{BM}} \cdot 100$$

where $\Delta DC$ is the percentage difference in drought index (DC) between the human-influenced ($DC_{HI}$) and benchmark ($DC_{BM}$) time series

```{r}
drought.char
```
```{r}
(drought.char$influenced - drought.char$benchmark) / drought.char$benchmark * 100
```

We find that the difference in mean duration is 236%, and in mean deficit volume it is 434%. To conclude, the mean duration of streamflow droughts in the Upper-Guadiana catchment has increased with about 236% and the mean deficit with 434% in the human-influenced situation compared to the naturalised situation.


