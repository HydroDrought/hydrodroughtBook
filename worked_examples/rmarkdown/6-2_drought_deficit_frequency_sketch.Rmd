---
title: "Drought deficit frequency analysis"
author: "Worked example 6.2"
---

```{r, setup, include=FALSE}
ggplot2::theme_set(ggplot2::theme_bw(base_size = 10))
knitr::opts_chunk$set(message = FALSE, warning = FALSE)
```

River Ngaruroro at Kuripapango in New Zealand, applied for frequency
analysis of annual minimum series in Worked Example 6.1, is here applied
for frequency analysis of drought deficit characteristics. The drought events
were derived using the Nizowka program (Software, CD) as described in
Worked Example 5.4 (Section 5.4.1). Partial duration series (PDS) of drought
events below a given threshold were selected from time series of daily
discharge, and $Q_{90}$ was selected as the threshold. Two drought characteristics
are analysed in the following: drought deficit volume and real drought
duration as defined in Worked Example 5.4.

# Data
```{r}
library(tidyverse)
library(hydroDrought)
library(lubridate)

ngaruroro <- intl %>%
  filter(river == "Ngaruroro") %>%
  select(data) %>%
  unnest(data) %>%
  # fill gaps with a length of up to 15 days
  sanitize_ts(approx.missing = 15) %>%
  mutate(
    year = water_year(time, origin = "-09-01")
  ) 
```


```{r}
# remove incomplete years
coverage <- ngaruroro %>%
  filter(!is.na(discharge)) %>%
  pull(time) %>%
  coverage_yearly(origin = "-09-01")

incomplete <- coverage %>%
  filter(days.missing > 0) %>%
  print()

complete <- coverage %>%
  filter(days.missing == 0)

ngaruroro <- ngaruroro %>%
  anti_join(incomplete, by = "year")
```

```{r, echo=FALSE}
ng <- ngaruroro
```


Drought events were selected for River Ngaruroro and details of the
selection criteria are given in Worked Example 5.4. The series cover the
period `r min(ng$year)` to `r max(ng$year)` and the start of the year is set to 1 September. 


A total of `r hydroDrought:::numbers_english(nrow(incomplete))` years were omitted from the series, 
`r hydroDrought:::paste_with_and(paste(incomplete$year, substr(incomplete$year + 1, 3L, 4L), sep = "/"))`, 
due to missing data.

```{r}
q90 <- lfquantile(ngaruroro$discharge, exc.freq = 0.9) 

droughts <- ngaruroro %>%
  drought_events(
    threshold = q90, pooling = "inter-event", 
    pooling.pars = list(min.duration = 2, min.vol.ratio = Inf), 
    full.table = TRUE
  ) %>%
  mutate(
    year = water_year(first.day, origin = "-09-01"),
    year = factor(year, levels = full_seq(ngaruroro$year, 1))
  )

tbl <- droughts %>%
  transmute(
    event, year, first.day, last.day, 
    duration = as.double(duration, units = "days"),
    real.duration = dbt, 
    volume = volume / 1e3,
    rel.volume = volume / (17.30839 * 86.4),
    # rel.volume = as.difftime(round(rel.volume, 2), unit = "days"), 
    average.deficit = volume / duration
  ) %>%
  print()
```


```{r echo=FALSE}
missing <- tbl %>%
  mutate(time = first.day) %>%
  mutate(
    year = water_year(first.day, origin = "-09-01")
  ) %>%
  pull(year) %>%
  setdiff(x = full_seq(ngaruroro$year, period = 1))

n <- diff(range(ngaruroro$year))
```

As only events below the $Q_{90}$
percentile are selected, it might happen that the flow never becomes less
than the threshold in a year (non-drought year). 

A total of `r hydroDrought:::numbers_english(length(missing))` out of the 
`r n - length(missing)` years with observations did not experience a drought 
(`r round(100 * length(missing) / n, 1)`%). The PDS
series of drought deficit volume and real duration are plotted in
Figure 6.12. Less severe values are found in the second half of the
observation period for both deficit volume (upper) and duration (lower).
The data are still treated as one sample as the number of observations is
considered insufficient for a separate analysis of two periods. It should
further be noted that a similar trend towards less severe droughts is not as
pronounced for the $AM(1)$ values (Worked Example 6.1). This is likely a
result of the high base flow contribution in the catchment (Figure 6.6).


```{r, echo=FALSE}
fig.cap <- "Figure 6.12 PDS of drought deficit volume (upper) and real duration (lower) for River
Ngaruroro at Kuripapango (NZ)."
```
```{r, echo=FALSE, fig.cap=fig.cap}
library(cowplot)
p1 <- ggplot(tbl, aes(x = first.day, y = average.deficit)) +
  geom_point() + 
  scale_x_date(expand = expansion(mult = 0.01), date_minor_breaks = "1 year") +
  scale_y_continuous(limits = c(0, 200), expand = expansion()) + 
  labs(y = expression(paste("Average deficit volume (", 10^{3}, m^{3}, ")"))) +
  theme(axis.title.x = element_blank())

p2 <- ggplot(tbl, aes(x = first.day, y = as.double(real.duration))) +
  geom_point() + 
  scale_x_date(expand = expansion(mult = 0.01), date_minor_breaks = "1 year") +
  scale_y_continuous(limits = c(0, 70), expand = expansion()) +
  labs(y = "Real duration (days)") + 
  theme(axis.title.x = element_blank())

cowplot::plot_grid(p1, p2, align = "v", axis = "x", ncol = 1)
```

# Derivation of distribution function
Following Zelenhasic & Salvai (1987) an estimate of the non-exceedance
probability, $F(x)$, for the largest event in each time interval is in Nizowka
obtained by combining the distribution for the occurrence of events and
the distribution for the magnitudes of deficit volume or duration. Here a
time interval of one year is chosen. Subsequently the return period in
years for a given event can be calculated. The number of drought events
occurring in a time period t is commonly assumed to be Poisson
distributed (Equation 6.9) with parameter $\lambda t$. In Nizowka the binomial
Pascal distribution is offered along with the Poisson distribution as
described in ‘Background Information NIZOWKA’ (Software, CD). The
distribution that best fitted deficit volume was the Pascal distribution for
the number of droughts and the GP distribution for the deficits. For
duration the Pascal distribution was chosen along with the Log-Normal
distribution. The $F(x)$ is for drought deficit volume plotted in Figure 6.13
together with the observed values plotted using a plotting position. The
chosen distribution describes the data well, with the exception of some
values in the upper range. The maximum value is, however, satisfactorily
modelled.



```{r, echo=FALSE}
library(lmom)
p <- 1 - c(1 / c(10, 100, 200))

observations <- tbl %>% 
  select(real.duration, rel.volume, abs.volume = volume) %>%
  mutate(across(everything(), as.numeric)) %>%
  pivot_longer(cols = everything(), names_to = "metric") %>%
  nest(data = value)  

fitted <- observations %>% 
  mutate(
    parameter = map(data, ~pelgpa(samlmu(.x$value))),
    quantiles = map(parameter, ~tibble(p = p, quant = quagpa(p, .x))),
    quafun = map(parameter, ~tibble(p = seq(0.01, 0.991, 0.001), quant = quagpa(p, .x)))
  )
```


```{r echo=FALSE, fig.height=8}
reduced_var <- function (x) -log(1 - x)

o <- observations %>%
  mutate(
    metric = factor(
      metric, levels = c("real.duration", "rel.volume", "abs.volume"),
      labels = c("Real duration\n(in days)", "Relative volume\n(in days)", 
                 "Absolute volume\n(in 1000 m³)"))
  ) %>%
  unnest(data) %>%
  group_by(metric) %>%
  mutate(prob = rank(value) / (n() + 1)) 

f <- fitted %>%
  mutate(
    metric = factor(
      metric, levels = c("real.duration", "rel.volume", "abs.volume"),
      labels = c("Real duration\n(in days)", "Relative volume\n(in days)", 
                 "Absolute volume\n(in 1000 m³)"))
  ) %>%
  select(metric, quafun) %>%
  unnest(quafun)

ggplot(o, aes(x = reduced_var(prob), y = value)) + 
  geom_point(size = 0.5) + 
  geom_line(data = f, aes(x = reduced_var(p), y = quant)) + 
  scale_x_continuous(
    expand = expansion(c(0.04, 0)), 
    sec.axis = sec_axis(
      trans = function(x) 1/ (1 - (-exp(-x) + 1)), 
      breaks = c(1, seq(10, 80, 10), 100, 150, 200),
      name = "Return period (in years)")
  ) + 
  facet_wrap(vars(metric), scales = "free_y", 
             ncol = 1, strip.position = "left") +
  labs(x = expression(paste("Exponential reduced variate -log(", 1, " - F(", x, "))")),
       y = "Quantile")
```


# Calculation of the T-year event
The return period of a given event is calculated following Equation 6.4.
The relationship between the drought characteristics as defined in Worked
Example 5.4 and $F(x)$ are given by the tabulated distribution functions in
Nizowka. The design value for a particular return period, i.e. the T-year
event, can be obtained from the tables for known values of $F(x)$. The
estimated 10-, 100- and 200-year drought events are shown in Table 6.2.


```{r, echo=FALSE}
fitted  %>%
  select(metric, quantiles) %>%
  unnest(quantiles) %>%
  pivot_wider(id_cols = p, names_from = "metric", values_from = "quant") %>%
  mutate(return.period = 1 / (1 - p)) %>%
  select(prob = p, return.period, everything())
```



# What about this approach

##  Partial duration series
```{r}
threshold <- 10
pds <- tbl %>%
  select(event, year, duration, first.day, last.day) %>%
  filter(duration > threshold) 
```


## Annual maxima series
```{r}
ams <- tbl %>%
  select(event, year, duration, first.day, last.day) %>%
  group_by(year) %>%
  slice_max(duration, with_ties = FALSE) %>%
  ungroup() %>%
  complete(year, fill = list(duration = 0))
```

## Fitting 


```{r, echo=FALSE}
prob_annual <- function(prob.pds, events.per.year)
{
  x <- (1 - (1 - prob.pds) / events.per.year )^events.per.year
  
  bad <- 1 - prob.pds > events.per.year
  if (any(bad)) {
    warning("1 - prob.pds must be <= events.per.year")
    x[bad] <- NA
  }
  
  return(x)
}


fit_distr <- function(x, dist, bound = NULL, correct.prob = FALSE)
{
  if (!correct.prob) correct.prob <- 1
  library(lmom)
  zeros <- x == 0
  freq.zeros <- sum(zeros) / length(x)
  if(dist %in% c("gpa", "ln3", "wak", "wei")) {
    par <- match.fun(paste0("pel", dist))(samlmu(x[!zeros], nmom = 5), bound = bound)  
  } else {
    par <- match.fun(paste0("pel", dist))(samlmu(x[!zeros], nmom = 5))
  }
  
  cdf <- match.fun(paste0("cdf", dist))
  qua <- match.fun(paste0("qua", dist))
  
  
  .cdf <- function(x, cdf, par, zeros, correct.prob = 1)
  {
    freq.zeros <- sum(zeros) / length(x)
    prob <- numeric(length(x))
    p1 <- cdf(x[!zeros], par)
    prob[!zeros] <- p1 * (1 - freq.zeros) + freq.zeros
    prob[zeros] <- seq(0, freq.zeros, length.out = sum(zeros))
    
    prob <- prob_annual(prob, events.per.year = correct.prob)
    return(prob)
  }
  
  .qua <- function(p, qua = qua, par, freq.zeros, correct.prob = 1)
  {
    quant <- numeric(length(p))
    zeros <- !is.na(p) & p <= freq.zeros
    p <- prob_annual(p, events.per.year = correct.prob)
    quant[zeros] <- 0
    p1 <- (p[!zeros] - freq.zeros) / (1 - freq.zeros)
    quant[!zeros] <- qua(f = p1, para = par)
    return(quant)
  }
  
  list(
    cdf = function(x) .cdf(x, cdf = cdf, par = par, zeros = zeros, 
                           correct.prob = correct.prob),
    qua = function(x) .qua(x, qua = qua, par = par, 
                           freq.zeros = freq.zeros,
                           correct.prob = correct.prob),
    par = par, 
    zeros = zeros)
}
```


```{r}
data <- tibble(
  series = c("AMS", "PDS", "PDS-corrected"),
  events.per.year = c(1, 1, nrow(pds) / nrow(ams)),
  bound = list(NULL, threshold, threshold),
  distribution = c("gum", "gpa", "gpa"),
  observations = list(ams$duration, pds$duration, pds$duration)
) %>%
  mutate(
    observations = map(observations, ~tibble(
      value = .x, 
      prob.emp = rank(value) / (length(value) + 1),
      rp.emp = (n() + 1) / rank(-value))
    ),
    fit = pmap(list(x = map(observations, "value"), 
                    dist = distribution, 
                    bound = bound,
                    correct.prob = events.per.year),
               fit_distr),
    fitted = map(fit, ~tibble(
      prob = seq(0.01, 1, 0.01),
      value = .x$qua(prob)
    )),
    quantiles = map(fit, ~tibble(
      rp = c(20, 50, 75, 100),
      prob = 1 - 1/rp,
      value = .x$qua(prob)
    ))
  )
```


```{r}
obs <- data %>%
  select(series, observations) %>%
  unnest(observations) 

fitted <- data %>%
  select(series, fitted) %>%
  unnest(fitted) 

ggplot(fitted, aes(y = value, col = series)) + 
  geom_line(aes(x = prob)) + 
  geom_point(aes(x = prob.emp), data = obs)
```


```{r}
x <- as.numeric(tbl$duration)
threshold <- 1
rp <- c(20, 50, 75, 100)
prob <- 1 - 1/rp


library(extRemes)
fit <- fevd(tbl$duration, threshold = threshold, type = "GP", method = "Lmoments",
          time.units = "years", verbose = T)
# rate is the mean number of exceedances per year
rate <- sum(x > threshold) / nrow(complete)
fit$rate <- rate

ci(fit, return.period = rp)

library(lmom)
parameter <- pelgpa(samlmu(x[x > threshold]), bound = threshold)
prob.adj <- 1 - (1 - prob)/rate
quagpa(prob.adj, parameter)
```

