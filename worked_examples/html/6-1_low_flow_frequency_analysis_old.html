<!DOCTYPE html>

<html>

<head>

<meta charset="utf-8" />
<meta name="generator" content="pandoc" />
<meta http-equiv="X-UA-Compatible" content="IE=EDGE" />

<meta name="viewport" content="width=device-width, initial-scale=1" />

<meta name="author" content="Worked example 6.1" />


<title>Low flow frequency analysis (dataset from first edition)</title>

<script src="site_libs/header-attrs-2.2/header-attrs.js"></script>
<link href="site_libs/tufte-css-2015.12.29/tufte-fonts.css" rel="stylesheet" />
<link href="site_libs/tufte-css-2015.12.29/tufte.css" rel="stylesheet" />
<link href="site_libs/highlightjs-9.12.0/default.css" rel="stylesheet" />
<script src="site_libs/highlightjs-9.12.0/highlight.js"></script>

<style type="text/css">code{white-space: pre;}</style>
<script type="text/javascript">
if (window.hljs) {
  hljs.configure({languages: []});
  hljs.initHighlightingOnLoad();
  if (document.readyState && document.readyState === "complete") {
    window.setTimeout(function() { hljs.initHighlighting(); }, 0);
  }
}
</script>




<link rel="stylesheet" href="style.css" type="text/css" />




</head>

<body>




<h1 class="title toc-ignore">Low flow frequency analysis (dataset from first edition)</h1>
<h4 class="author">Worked example 6.1</h4>


<div id="TOC">
<ul>
<li><a href="#loading-the-data"><span class="toc-section-number">1</span> Loading the Data</a></li>
<li><a href="#derivation-of-an-empirical-distribution-function"><span class="toc-section-number">2</span> Derivation of an empirical distribution function</a></li>
<li><a href="#fitting-a-distribution"><span class="toc-section-number">3</span> Fitting a distribution</a></li>
<li><a href="#ft"><span class="toc-section-number">4</span> Fast Track</a></li>
<li><a href="#probability-plot-using-the-exponential-reduced-variate"><span class="toc-section-number">5</span> Probability plot using the exponential reduced variate</a></li>
</ul>
</div>

<div id="loading-the-data" class="section level1" number="1">
<h1 number="1"><span class="header-section-number">1</span> Loading the Data</h1>
<p>River Ngaruroro at Kuripapango in New Zealand (Table 4.3), has been selected for frequency analysis of annual minimum 1-day values, <span class="math inline">\(AM(1)\)</span>, using the Weibull (WEI) distribution. In mid-latitudes in the Northern Hemisphere the calendar year can often be used to select the annual minimum flows. This is a suitable period for the selection of independent events as the drought or low flow period commonly occurs during the summer months. In the Southern Hemisphere the low flow season occurs at the opposite time of the year, and for Ngaruroro the lowest flows are typically found in the period November to May. As a result <span class="math inline">\(AM(1)\)</span> flows were selected for a hydrological year starting at the 1<sup>st</sup> September.</p>
<p><label for="tufte-sn-1" class="margin-toggle sidenote-number">1</label><input type="checkbox" id="tufte-sn-1" class="margin-toggle"><span class="sidenote"><span class="sidenote-number">1</span> Tobias: Right now the old dataset is used to make sure we can reporoduce the numbers from the first edition. Changing to the new dataset will change the results quite a little.</span></p>
<pre class="r"><code>library(tidyverse)
library(hydroDrought)
ngaruroro &lt;- hydroDrought:::ngFirstEdition %&gt;%
  mutate(
    year = water_year(time, origin = &quot;-09-01&quot;)
  ) %&gt;%
  filter(year &gt;= 1964, year &lt; 2000) %&gt;%
  print()</code></pre>
<pre><code>## # A tibble: 13,149 x 3
##    time       discharge  year
##    &lt;date&gt;         &lt;dbl&gt; &lt;dbl&gt;
##  1 1964-09-01     10.8   1964
##  2 1964-09-02     12.0   1964
##  3 1964-09-03     11.2   1964
##  4 1964-09-04     10.4   1964
##  5 1964-09-05      9.90  1964
##  6 1964-09-06      9.97  1964
##  7 1964-09-07      9.97  1964
##  8 1964-09-08     10.5   1964
##  9 1964-09-09     16.2   1964
## 10 1964-09-10     18.4   1964
## # … with 13,139 more rows</code></pre>
<pre class="r"><code># remove the same years as in figure 6.9 of the first edition
incomplete &lt;- tibble(year = c(1965, 1978, 1986, 1987, 2000))

# derivation of the annual minima, first remove years with missing values
am &lt;- ngaruroro %&gt;%
  anti_join(incomplete, by = &quot;year&quot;) %&gt;%
  group_by(year) %&gt;%
  summarise(flow = min(discharge, na.rm = TRUE)) %&gt;%
  arrange(flow)</code></pre>
<div class="figure">
<p class="caption marginnote shownote">
Figure 6.9 Time series of annual minimum 1-day flow, AM(1), for River Ngaruroro at Kuripapango (NZ).
</p>
<img src="6-1_low_flow_frequency_analysis_old_files/figure-html/unnamed-chunk-4-1.png" alt="Figure 6.9 Time series of annual minimum 1-day flow, AM(1), for River Ngaruroro at
Kuripapango (NZ)." width="672"  />
</div>
<div class="figure">
<p class="caption marginnote shownote">
Sample annual minimum 1-day flow, AM(1), for River Ngaruroro at Kuripapango (NZ); histogram
</p>
<img src="6-1_low_flow_frequency_analysis_old_files/figure-html/unnamed-chunk-6-1.png" alt="Sample annual minimum 1-day flow, AM(1), for River Ngaruroro at
Kuripapango (NZ); histogram" width="672"  />
</div>
<p>Ngaruroro has a flashy river regime, but has no observed zero flows. The <span class="math inline">\(AM(1)\)</span> flows are considered to come from the same population as only a minor part of the catchment is influenced by snow in winter. The observations cover the period 1964 to 1964 and with the omission of 5 years (1965, 1978, 1986, 1987 and 2000) with missing data a total of 32 values results. A histogram of the values is shown in Figure 6.3 (upper left). To test the assumption of stationarity the <span class="math inline">\(AM(1)\)</span> values are plotted against time in Figure 6.9. No trend can be detected in the series and the data are therefore assumed to fulfil the requirement of independent and identically distributed data (iid).</p>
</div>
<div id="derivation-of-an-empirical-distribution-function" class="section level1" number="2">
<h1 number="2"><span class="header-section-number">2</span> Derivation of an empirical distribution function</h1>
<pre class="r"><code>empirical &lt;- am %&gt;%
  mutate(
    rank = rank(flow),
    prob.emp = rank / (n() + 1),
    rp.emp = 1 / prob.emp
  ) %&gt;%
  arrange(rank)  %&gt;%
  print()</code></pre>
<pre><code>## # A tibble: 32 x 5
##     year  flow  rank prob.emp rp.emp
##    &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt;    &lt;dbl&gt;  &lt;dbl&gt;
##  1  1977  2.60     1   0.0303  33   
##  2  1982  2.69     2   0.0606  16.5 
##  3  1972  2.78     3   0.0909  11   
##  4  1973  3.02     4   0.121    8.25
##  5  1967  3.21     5   0.152    6.6 
##  6  1993  3.24     6   0.182    5.5 
##  7  1997  3.38     7   0.212    4.71
##  8  1981  3.42     8   0.242    4.12
##  9  1992  3.81     9   0.273    3.67
## 10  1968  3.83    10   0.303    3.3 
## # … with 22 more rows</code></pre>
<ol style="list-style-type: lower-alpha">
<li><p>The <span class="math inline">\(x\)</span> values, AM(1), are sorted in ascending order and the rank of each value is calculated. The smallest value equals 2.596 in m<sup>3</sup>s<sup>-1</sup> and is given rank 1.</p></li>
<li><p>The non-exceedance probability, <span class="math inline">\(F(x) = p\)</span>, (column <code>prob.emp</code>) is calculated for each <span class="math inline">\(x\)</span> value using the Weibull plotting position formula <span class="math inline">\(p_i = i / (n + 1)\)</span> (Equation 6.6).</p></li>
<li><p>A probability plot for the <span class="math inline">\(AM(1)\)</span> values is obtained by plotting the flow values against <span class="math inline">\(F(x)\)</span> as demonstrated in Figure 6.10 (upper). A staircase pattern of several nearly equal values is observed. (Note that the <span class="math inline">\(AM(1)\)</span> values now are plotted on the <span class="math inline">\(y\)</span>-axis as compared to Figure 6.3, lower).</p></li>
<li><p>The return period (column <code>rp.emp</code>) of the smallest event can be calculated following Equation 6.5. The non-exceedance frequency, <span class="math inline">\(F(x)\)</span>, of the smallest event equals 0.03 according to step 2(b), which gives a return period of 33 years.</p></li>
</ol>
</div>
<div id="fitting-a-distribution" class="section level1" number="3">
<h1 number="3"><span class="header-section-number">3</span> Fitting a distribution</h1>
<p>Fitting the two-parameter Weibull (WEI) distribution function (Section A6.1.4) using the method of L-moments and the fact that <span class="math inline">\(Y = −\ln(X)\)</span> has a Gumbel distribution if <span class="math inline">\(X\)</span> has a WEI distribution. <label for="tufte-sn-2" class="margin-toggle sidenote-number">2</label><input type="checkbox" id="tufte-sn-2" class="margin-toggle"><span class="sidenote"><span class="sidenote-number">2</span> The direct estimation of the Weibull parameters is shown in <a href="#ft">section Fast Track</a>. </span></p>
<ol style="list-style-type: lower-alpha">
<li>The first two L-moments (<span class="math inline">\(\hat\lambda_1\)</span> and <span class="math inline">\(\hat\lambda_2\)</span>) are estimated based on time series of <span class="math inline">\(\ln(x)\)</span>. These so called sample L-moments are calculated with the function <code>samlmu()</code> from the package <strong>lmom</strong>.</li>
</ol>
<pre class="r"><code>library(lmom)
moments &lt;- samlmu(log(am$flow))
moments </code></pre>
<pre><code>##         l_1         l_2         t_3         t_4 
##  1.39045776  0.11993052 -0.04274446  0.17181424</code></pre>
<ol start="2" style="list-style-type: lower-alpha">
<li>The parameter estimates of the WEI distribution (shape parameter <span class="math inline">\(\kappa\)</span>, scale parameter <span class="math inline">\(\alpha\)</span>) are obtained following Stedinger et al. (1993):</li>
</ol>
<p><span class="math inline">\(\hat\kappa = \frac{\ln(2)}{\hat\lambda_2}\)</span> and <span class="math inline">\(\hat\alpha = \exp\left( \hat\lambda_1 + \frac{0.5772}{\hat\kappa}\right)\)</span></p>
<p><label for="tufte-sn-3" class="margin-toggle sidenote-number">3</label><input type="checkbox" id="tufte-sn-3" class="margin-toggle"><span class="sidenote"><span class="sidenote-number">3</span> Tobias: The shape parameter <span class="math inline">\(\hat\kappa\)</span> differns quite a lot from the result by the lmom-package (<span class="math inline">\(\hat\kappa = 5.502302\)</span>). I cannot figure out why thats the case. Susbsequently the quantile and probability estimates in section Fast-Track are also slightly off.</span></p>
<pre class="r"><code>kappa &lt;- log(2) / unname(moments[&quot;l_2&quot;])
alpha &lt;- exp(unname(moments[&quot;l_1&quot;]) + 0.5772 / kappa)
parameter &lt;- c(location = 0, scale = alpha, shape = kappa)
parameter</code></pre>
<pre><code>## location    scale    shape 
## 0.000000 4.438545 5.779573</code></pre>
<ol start="3" style="list-style-type: lower-alpha">
<li><span class="math inline">\(F(x)\)</span> for the WEI distribution is obtained following Equation A6.1.33 (recalling that location parameter <span class="math inline">\(\xi\)</span> is set to zero):</li>
</ol>
<p><span class="math display">\[ F(x) = 1 - \exp\left[-\left(\frac{x}{\alpha}\right)^\kappa\right]\]</span></p>
<pre class="r"><code>fitted &lt;- empirical %&gt;%
  select(year, flow, prob.emp) %&gt;%
  mutate(
    prob.wei = 1 - exp(-(flow / alpha)^kappa),
    rp.wei = 1 / prob.wei
  ) </code></pre>
<div class="figure">
<p class="caption marginnote shownote">
Figure 6.10 (upper): Estimated quantiles for annual minimum 1-day flow, AM(1), for River Ngaruroro at Kuripapango (NZ); probability plot showing the Weibull distribution (curve).
</p>
<img src="6-1_low_flow_frequency_analysis_old_files/figure-html/unnamed-chunk-14-1.png" alt="Figure 6.10 (upper): Estimated quantiles for annual minimum 1-day flow, AM(1), for River
Ngaruroro at Kuripapango (NZ); probability plot showing the Weibull distribution
(curve)." width="672"  />
</div>
<div class="figure">
<p class="caption marginnote shownote">
Figure 6.10 (lower): QQ-plot of empirical quantiles versus Weibull quantiles
</p>
<img src="6-1_low_flow_frequency_analysis_old_files/figure-html/unnamed-chunk-16-1.png" alt="Figure 6.10 (lower): QQ-plot of empirical quantiles versus Weibull quantiles" width="672"  />
</div>
<p><label for="tufte-sn-4" class="margin-toggle sidenote-number">4</label><input type="checkbox" id="tufte-sn-4" class="margin-toggle"><span class="sidenote"><span class="sidenote-number">4</span> Tobias: The plot doesn’t show quantiles (as mentioned in the first edition where it is called a QQ-Plot), but probabilities… </span></p>
<ol start="4" style="list-style-type: lower-alpha">
<li><p>The data can be plotted in a probability plot and compared to the empirical quantiles in step 2(b) (Figure 6.10, upper). The plot shows that the WEI distribution is well adjusted to the low flow extreme values, whereas the deviation in the upper range might suggest that the three highest values do not belong to the low flow population (Section 6.3.3). In Figure 6.10 (lower) the empirical quantiles are plotted against the estimated distribution quantiles (qq-plot). The points should be close to the unit diagonal if the data fit the WEI distribution well. The use of a plotting position implies that the ordered sample is plotted in regularly spaced positions. As demonstrated in the figure, the observed jumps in <span class="math inline">\(AM(1)\)</span> values are reflected in the estimated Weibull quantiles, but not in the empirical quantiles.</p></li>
<li><p>The non-exceedance frequency of the smallest value equals 0.0441 (Equation A6.1.33), which gives a return period of 22.7 years (Equation 6.5). This is 10.3 years less that the empirical estimate derived in step 2(d).</p></li>
</ol>
<pre class="r"><code>fitted</code></pre>
<pre><code>## # A tibble: 32 x 5
##     year  flow prob.emp prob.wei rp.wei
##    &lt;dbl&gt; &lt;dbl&gt;    &lt;dbl&gt;    &lt;dbl&gt;  &lt;dbl&gt;
##  1  1977  2.60   0.0303   0.0441  22.7 
##  2  1982  2.69   0.0606   0.0539  18.5 
##  3  1972  2.78   0.0909   0.0647  15.4 
##  4  1973  3.02   0.121    0.102    9.80
##  5  1967  3.21   0.152    0.142    7.02
##  6  1993  3.24   0.182    0.151    6.64
##  7  1997  3.38   0.212    0.186    5.39
##  8  1981  3.42   0.242    0.199    5.04
##  9  1992  3.81   0.273    0.340    2.94
## 10  1968  3.83   0.303    0.348    2.87
## # … with 22 more rows</code></pre>
<ol start="6" style="list-style-type: lower-alpha">
<li>The 50 and 100-year events can be estimated from Equation A6.1.34: <span class="math display">\[ x_p = \xi + \alpha \left[-\ln( 1 - p ) \right]^{1/\kappa} \]</span></li>
</ol>
<pre class="r"><code>quantile_weibull &lt;- function(prob, location = 0, scale, shape) {
  location + scale * (-log(1 - prob))^(1/shape)
}

return.period &lt;- c(50, 100)
q &lt;- quantile_weibull(prob = 1/return.period, scale = alpha, shape = kappa) 

round(q, 2)</code></pre>
<pre><code>## [1] 2.26 2.00</code></pre>
<p>which gives: <span class="math inline">\(\hat x_{50} = 2.26\)</span>m<sup>3</sup>s<sup>-1</sup> and <span class="math inline">\(\hat x_{100} = 2.00\)</span>m<sup>3</sup>s<sup>-1</sup>.</p>
</div>
<div id="ft" class="section level1" number="4">
<h1 number="4"><span class="header-section-number">4</span> Fast Track</h1>
<p>To obtain L-moment estimates of the two parameter Weibull distribution the lower bound (location parameter <span class="math inline">\(\xi\)</span>) is set to zero otherwise a three parameter distribution is fitted.</p>
<pre class="r"><code>library(lmom)
lmom &lt;- samlmu(am$flow)
par.wei &lt;- pelwei(lmom, bound = 0)
par.wei</code></pre>
<pre><code>##     zeta     beta    delta 
## 0.000000 4.445769 5.502302</code></pre>
<p>Quantiles for given probabilities can be calculated for many suitable distribution by the corresponding <code>qua...()</code> functions.</p>
<pre class="r"><code>quawei(f = c(0.02, 0.01), para = par.wei) %&gt;%
  round(digits = 2)</code></pre>
<pre><code>## [1] 2.19 1.93</code></pre>
</div>
<div id="probability-plot-using-the-exponential-reduced-variate" class="section level1" number="5">
<h1 number="5"><span class="header-section-number">5</span> Probability plot using the exponential reduced variate</h1>
<pre class="r"><code>fitted.fast &lt;- am %&gt;%
  mutate(
    prob.emp = rank(flow) / (n() + 1),
    prob.wei = cdfwei(x = flow, para = pelwei(lmom, bound = 0)),
    prob.exp = cdfexp(x = flow, para = pelexp(lmom))
  ) %&gt;% 
  arrange(flow) %&gt;%
  print()</code></pre>
<pre><code>## # A tibble: 32 x 5
##     year  flow prob.emp prob.wei prob.exp
##    &lt;dbl&gt; &lt;dbl&gt;    &lt;dbl&gt;    &lt;dbl&gt;    &lt;dbl&gt;
##  1  1977  2.60   0.0303   0.0505   0     
##  2  1982  2.69   0.0606   0.0612   0     
##  3  1972  2.78   0.0909   0.0727   0     
##  4  1973  3.02   0.121    0.112    0     
##  5  1967  3.21   0.152    0.153    0.0764
##  6  1993  3.24   0.182    0.162    0.108 
##  7  1997  3.38   0.212    0.197    0.221 
##  8  1981  3.42   0.242    0.210    0.255 
##  9  1992  3.81   0.273    0.349    0.503 
## 10  1968  3.83   0.303    0.357    0.513 
## # … with 22 more rows</code></pre>
<ol style="list-style-type: lower-alpha">
<li><p>For comparison of the two-parameter EXP (Equation A6.1.64) and WEI distribution the exponential reduced variable is applied (Box 6.4). By substituting <span class="math inline">\(y\)</span> into the expression for <span class="math inline">\(F(x)\)</span>, <span class="math inline">\(y\)</span> can be expressed as <span class="math inline">\(-\ln(1 - F(x))\)</span> (Equation B6.4.6). The parameters of the EXP distribution are estimated using L-moments (Equation A6.1.72) and used to calculate <span class="math inline">\(y\)</span> and subsequently <span class="math inline">\(F(x)\)</span>.</p></li>
<li><p>The non-exceedance probability <span class="math inline">\(F(x)\)</span> for the observations is determined using the Weibull plotting position formula (Equation 6.6).</p></li>
<li><p>The <span class="math inline">\(AM(1)\)</span> values are plotted against the reduced variate in Figure 6.11. A reduced variate of <span class="math inline">\(0.02\)</span> corresponds to a return period of <span class="math inline">\(50.5\)</span> years for minimum values (Equation 6.5). The data will plot as a straight line given they follow the EXP distribution. Again it is demonstrated that the WEI distribution fits the extreme low flow values well, and also the upper range apart from the three largest values. The two-parameter EXP distribution is less suited to model the sample. Alternatively, <span class="math inline">\(\ln(X)\)</span> could be plotted on a Gumbel probability paper, and a straight line would result provided the data fitted the WEI distribution.</p></li>
</ol>
<div class="figure">
<p class="caption marginnote shownote">
Figure 6.11: The annual minimum 1-day flow, AM(1), plotted against the reduced variate, y, of the EXP distribution for River Ngaruroro at Kuripapango (NZ); the observations marked as points, the two-parameter EXP distribution (continous line) and the two-parameter WEI distribution (dashed line).
</p>
<img src="6-1_low_flow_frequency_analysis_old_files/figure-html/unnamed-chunk-23-1.png" alt="Figure 6.11: The annual minimum 1-day flow, AM(1), plotted against the reduced variate, y, of the EXP distribution for River Ngaruroro at Kuripapango (NZ); the observations marked as points, the two-parameter EXP distribution (continous line) and the two-parameter WEI distribution (dashed line)." width="672"  />
</div>
</div>



<!-- code folding -->


<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    script.src  = "https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML";
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>

</body>
</html>
