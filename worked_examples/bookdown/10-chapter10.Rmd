# Chapter 10

## Worked example 10.1: Quantifying effect of human influences


```{r, echo = FALSE}
library(tidyverse)
library(hydroDrought)
# Let's pretend the data is already inside the package...
guadiana <- read_tsv("../../data/Guadiana_Delay_LogEff_including_Psim.txt") %>%
  dplyr::select(time = "date.yyyymmdd",  Qsim, Qobs)  # %>%
# append_group(by = "day")
```


If we want to quantify the human influence on hydrological drought by comparing two time series, one with and one without this human influence, we want to use the threshold of the **benchmark** time series to calculate droughts in both the **human-influenced** and **benchmark** time series. These are the steps that we will discuss in this Worked Example:

1) Calculate the threshold from the **benchmark** time series

2) Calculate **benchmark** drought characteristics for the **benchmark** time series with the **benchmark** threshold

3) Calculate **human-influenced** drought characteristics for the **human-influenced** time series with the **benchmark** threshold

4) Compare drought characteristics between the **benchmark** & **human-influenced** time series


### Loading the data

As an example we here use the Upper-Guadiana dataset with the two time series: the **benchmark** time series and the **human-influenced** time series. 

```{r}
library(tidyverse)
library(lubridate)
library(hydroDrought)

### Filter to a specific period
guadiana_period <- guadiana %>%
	dplyr::select(time, discharge = Qsim) %>%
  	mutate(
    	year = water_year(time)
	) %>%
	filter(year >= 1960,  year <= 2000) %>%

print(guadiana_period)
range(guadiana_period$time)
```

The **benchmark** time series comprises the uninfluenced, naturalized discharge $Q_{sim}$. Note that **benchmark** time series can be calculated from a paired catchment analysis, an upstream-downstream comparison, model naturalisation, or pre-post disturbance analysis (Sect. 10.4.1 and 10.5.1) or from model scenarios (Sect. 10.4.3, 4 and 10.5.3, 4). The **benchmark** time series for this catchment are modelled as described in Sect. XX.

```{r}
benchmark <- guadiana_period  %>%
	filter(year >= 1981,  year <= 2000) %>%
  print()
```

The **human-influenced** time series is basically the time series of observed discharge $Q_{obs}$ from the Upper-Guadiana catchment. 

```{r}
influenced <- guadiana_period %>%
	filter(year >= 1991,  year <= 2000) %>%
	print()
```


### Threshold calculation

Here we are taking the `benchmark` time series. First we are smoothing the column `discharge` with a 30-day moving average. The threshold itself is calculated as a daily varying $Q_{80}$ yielding a dataset with a row for each day of the year and the appropriate $Q_{80}$ in the column named `threshold`. 

```{r}
threshold <- guadiana_period %>%
  # applying a 30-day moving average smoother
  mutate(discharge = moving_average(discharge, n = 30, sides = "center")) %>%
  
  # computing the Q80 for each day of the year
  var_threshold(vary.by = "day", fun = lfquantile, exc.freq = 0.80) 

print(threshold)
```


```{r}
p <- ggplot(data = threshold, aes(x = day, y = threshold)) + 
  geom_step() + 
  scale_x_date(date_breaks = "1 months", date_labels = "%b", 
               expand = expansion()) + 
  theme(axis.title.x = element_blank())

p
```


```{r}
### Add Julian date columns to the benchmark and threshold
benchmark <- benchmark %>% 
	mutate(jdate = yday(time))

threshold <- threshold %>% 
	mutate(jdate = yday(day), year = year(day))

### Plot the threshold against monthly flows in log10 space
p <- ggplot(benchmark, aes(x=jdate)) + 
	geom_line(aes(group=year, y=discharge), alpha = 0.2) + 
	geom_line(data = threshold, aes(y=threshold), colour="red") + 
    scale_x_continuous(name = "Julian Date", expand = expansion()) +
	scale_y_log10()

p


plot_df <- guadiana_period %>%	mutate(jdate = yday(time), line = "thresh_basis", facet = "thresh_basis") %>%
	bind_rows(benchmark %>% mutate(line = "benchmark", facet = "benchmark")) %>%
	bind_rows(influenced %>% mutate(jdate = yday(time), line = "influenced", facet = "influenced")) %>%
	left_join(threshold %>% dplyr::select(jdate, threshold), by = "jdate") %>%
	mutate(line = factor(line, levels = c("thresh_basis", "benchmark", "influenced"), labels = c("Threshold\nBasis", "Benchmark", "Human\nInfluenced"))) %>%
	mutate(facet = factor(facet, levels = c("thresh_basis", "benchmark", "influenced"), labels = c("Threshold Basis", "Benchmark", "Influenced"))) %>%
	mutate(label = "Threshold")


p <- ggplot(plot_df, aes(x=time)) %>%
	+ geom_line(aes( y=discharge, colour = line)) %>%
	+ geom_line(aes(y = threshold), colour = "grey20") %>%
	+ facet_grid(facet~.) %>%
	+ scale_y_log10()

p

p <- ggplot(plot_df, aes(x=time)) %>%
	+ geom_line(aes( y=discharge, colour = line)) %>%
	+ facet_grid(facet~.)

p



p <- ggplot(plot_df %>% filter(year >=1980 & facet != "Threshold Basis"), aes(x=jdate)) %>%
	+ geom_line(aes( y=discharge, colour = line)) %>%
	+ geom_step(aes(y = threshold, colour = label), linetype = "dashed", size = 0.2) %>%
	+ facet_grid(year ~ facet, scales = "free_x") %>%
	+ scale_colour_manual(values = c("black", "#377eb8", "red"), limits = c("Benchmark", "Human\nInfluenced", "Threshold")) %>%
 # 	+ scale_x_date(date_breaks = "1 month", date_labels = "%b") %>%
	+ scale_y_log10()

p



p <- ggplot(plot_df %>% filter(year >=1980 & facet != "Threshold Basis"), aes(x=jdate)) %>%
	+ geom_line(aes( y=discharge, colour = line)) %>%
	+ geom_step(aes(y = threshold, colour = label), linetype = "dashed", size = 0.2) %>%
	+ facet_grid(year ~ facet, scales = "free_x") %>%
	+ scale_colour_manual(values = c("black", "#377eb8", "red"), limits = c("Benchmark", "Human\nInfluenced", "Threshold")) %>%
  	#+ scale_x_date(date_breaks = "1 month", date_labels = "%b") %>%
	+ scale_y_log10() %>%
	+ theme_bw(8)

p



ggplot(benchmark, aes(x=time)) %>%
	+ geom_line(aes( y=discharge)) %>%
	+ geom_line(data = benchmark %>% left_join(threshold, by = "jdate"), aes(y=threshold), colour="red")



### Plot the threshold against monthly flows in log10 space
ya <-  benchmark %>%
  mutate(discharge = moving_average(discharge, n = 30, sides = "center")) %>%
  filter(year >= 1960,  year <= 2000)

p <- ggplot(ya %>% drop_na(), aes(x=jdate)) + 
	geom_line(aes(group=year, y=discharge), alpha = 0.2) + 
	geom_line(data = threshold, aes(y=threshold), colour="red") + 
    scale_x_continuous(name = "Julian Date", expand = expansion()) + 
	scale_y_log10()

p


threshold <- threshold %>% 
	dplyr::select(-jdate, -year)
```




### Benchmark Drought characteristics

^[Tobias: I think this Worked Example could be easier to follow if we fist compute the drought events for both time series and in a separate section the drought characteristics. So section 2 could become "Drought Events", Section 3 "Drought Characteristics".]

```{r}
# initialize empty list for events
events <- list(benchmark = NULL, influenced = NULL)

# initialize empty list for final drought characteristics
drought.char <- list(benchmark = NULL, influenced = NULL) 

# function that computes the drought characteristics given a table of events
summarize_dc <- function(x) {
  c("mean.duration" = as.double(mean(x$duration)), 
    "mean.deficit" = mean(x$volume))
}
```

Periods with discharges below the before calculated threshold are considered drought events.   Consecutive drought events with an inter-event time of less than or equal to 10 days (argument `min.duration = 10`) get pooled into a single drought event regardless of their inter-event excess volume (argument `min.vol.ratio = Inf`). To get rid of minor droughts, only drought events with a duration of more than 10 days are kept. 

```{r}
# calculate the drought events for the benchmark time series
events$benchmark <- benchmark %>%
  filter(year >= 1981, year <= 2000) %>%
  drought_events(
    threshold = threshold,
    pooling = "inter-event",
    pooling.pars = list(min.duration = 10, min.vol.ratio = Inf)
  )  %>%
  filter(duration > 10)

# calculate the drought characteristics for the benchmark time series
drought.char$benchmark <- summarize_dc(events$benchmark)
```


For the Upper-Guadiana, these would be the drought events of the **benchmark** time series. Note that this calculation can be applied for a different time period than was used to calculate the **benchmark** threshold (for example, for Upper-Guadiana, we are using the period 1981-2000). Events numbers that are missing in the sequence are minor drought events that have been filtered out.
```{r}
print(events$benchmark)
```



### Human-influenced drought characteristics 

We will now do the same drought calculation on the human-influenced time series, using the same period as for the benchmark drought calculation (here: 1981-2000).

```{r, warning=FALSE, echo=FALSE, fig.width=8, fig.height=10}
infl <- influenced %>%
  mutate(
    day = group_ts(time = time, by = "day")
  ) %>%
  filter(year >= 1991 & year <= 2000) %>%
  left_join(threshold, by = "day")

infl %>%
  ggplot() + 
  geom_line(aes(x = time, y = discharge)) + 
  geom_step(aes(x = time, y = threshold), 
            linetype = "dashed", size = 0.2, col = "red") + 
  scale_x_date(date_breaks = "1 month", date_labels = "%b") +
  scale_y_log10() +
  facet_wrap(~year, scales = "free_x", ncol = 1, strip.position = "right")
```



```{r}
# calculate the drought events for the human influenced time series
events$influenced <- influenced %>%
  filter(year >= 1991 & year <= 2000) %>%
  drought_events(threshold = threshold,
                 pooling = "inter-event",
                 pooling.pars = list(min.duration = 10, min.vol.ratio = Inf))  %>%
  filter(duration > 10)

# calculate the drought characteristics for the human influenced time series
drought.char$influenced <- summarize_dc(events$influenced)
```



### Comparison of drought characteristics    

For the Upper-Guadiana, these would be the drought characteristics:
```{r}
drought.char
```


Calculate the percentage difference between the **benchmark** and **human-influenced** drought characteristics.

$$\Delta DC = \frac{DCHI - DCBM}{DCBM} \cdot 100$$
where $\Delta DC$ is the percentage change in drought characteristics ($DC$) between the **human-influenced** ($DCHI$) and **benchmark** ($DCBM$) time series.
For the Upper-Guadiana, these would be the differences in drought characteristics:

```{r}
(drought.char$influenced - drought.char$benchmark) / drought.char$benchmark * 100
```




